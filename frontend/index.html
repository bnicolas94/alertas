<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Alertas de Noticias Económicas</title>
    <style>
      :root {
        font-family: Arial, Helvetica, sans-serif;
        color-scheme: light dark;
        --bg: #f5f5f5; --card-bg: #ffffff;
        --text-primary: #1a202c; --text-secondary: #4a5568;
        --accent: #2563eb; --card-shadow: rgba(0,0,0,.1) 0 4px 6px;
        --muted: #e2e8f0;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #1a202c; --card-bg: #2d3748;
          --text-primary: #edf2f7; --text-secondary: #a0aec0;
          --accent: #63b3ed; --card-shadow: rgba(0,0,0,.5) 0 4px 6px;
          --muted: #4a5568;
        }
      }
      body { margin:0; padding:0; background:var(--bg); display:flex; flex-direction:column; min-height:100vh; }
      header { padding:1rem 2rem; text-align:center; background:var(--card-bg); box-shadow:var(--card-shadow); }
      h1 { margin:0; font-size:1.75rem; color:var(--accent); }
      main { flex:1; display:grid; grid-template-columns: 280px 1fr; gap:1rem; padding:1rem 2rem; }
      @media (max-width: 900px) { main { grid-template-columns: 1fr; } }
      .panel { background:var(--card-bg); padding:1rem; border-radius:.5rem; box-shadow:var(--card-shadow); }
      .panel h2 { margin:.2rem 0 1rem; font-size:1rem; color:var(--text-primary); }
      .panel label { display:block; font-size:.9rem; margin:.4rem 0 .2rem; color:var(--text-secondary); }
      .panel input[type=text], .panel select {
        width:100%; padding:.5rem; border-radius:.4rem; border:1px solid var(--muted);
        background:transparent; color:var(--text-primary);
      }
      .panel .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
      .btn { padding:.4rem .6rem; border-radius:.4rem; border:1px solid var(--muted); background:transparent; cursor:pointer; color:var(--text-primary); }
      .alerts { display:flex; flex-direction:column; gap:1rem; }
      .alert-card { background:var(--card-bg); padding:1rem; border-radius:.5rem; box-shadow:var(--card-shadow); transition:transform .2s ease; }
      .alert-card:hover { transform: translateY(-3px); }
      .alert-header { display:flex; align-items:flex-start; justify-content:space-between; gap:.75rem; margin-bottom:.5rem; }
      .alert-headline { font-size:1.1rem; font-weight:bold; color:var(--text-primary); line-height:1.35; }
      .alert-headline a { color:inherit; text-decoration:none; } .alert-headline a:hover { text-decoration:underline; }
      .alert-category { font-size:.85rem; font-weight:600; text-transform:uppercase; color:var(--accent); white-space:nowrap; }
      .alert-summary { font-size:.95rem; color:var(--text-secondary); margin-bottom:.5rem; }
      .alert-meta { font-size:.8rem; color:var(--text-secondary); display:flex; flex-wrap:wrap; align-items:center; gap:.4rem; }
      .ticker { display:inline-block; padding:.1rem .3rem; background:var(--accent); color:#fff; border-radius:.25rem; font-size:.75rem; }
      .muted { color:var(--text-secondary); }
      .chip { display:inline-block; padding:.15rem .4rem; background:var(--muted); border-radius:.4rem; font-size:.75rem; margin-right:.25rem; }
    </style>
  </head>
  <body>
    <header><h1>Alertas de Noticias Económicas en Tiempo Real</h1></header>

    <main>
      <!-- PANEL DE FILTROS -->
      <aside class="panel">
        <h2>Filtros</h2>

        <label>Buscar (titular / fuente)</label>
        <input id="q" type="text" placeholder="litio, earnings, merger, Tesla..." />

        <div class="row" style="margin-top:.5rem">
          <label style="margin-right:.5rem">Idiomas:</label>
          <label><input type="checkbox" id="lang-es" checked> ES</label>
          <label><input type="checkbox" id="lang-en" checked> EN</label>
          <label><input type="checkbox" id="lang-oth" checked> Otros</label>
        </div>

        <label style="margin-top:.6rem">Categorías</label>
        <div class="row">
          <label><input type="checkbox" class="cat" value="GovStake" checked> GovStake</label>
          <label><input type="checkbox" class="cat" value="CEOResignation" checked> CEO</label>
          <label><input type="checkbox" class="cat" value="M&A" checked> M&A</label>
          <label><input type="checkbox" class="cat" value="Earnings" checked> Earnings</label>
          <label><input type="checkbox" class="cat" value="Contract" checked> Contract</label>
          <label><input type="checkbox" class="cat" value="News" checked> News</label>
        </div>

        <label style="margin-top:.6rem">Solo medios confiables</label>
        <div class="row">
          <label><input type="checkbox" id="trusted-only"> Reuters/Bloomberg/WSJ/FT/AP</label>
        </div>

        <label style="margin-top:.6rem">Dominios permitidos (coma-sep.)</label>
        <input id="domains" type="text" placeholder="reuters.com, bloomberg.com, wsj.com" />

        <div class="row" style="margin-top:.8rem">
          <label>Límite de tarjetas</label>
          <select id="limit">
            <option>50</option><option selected>100</option><option>200</option><option>500</option>
          </select>
          <button id="clear" class="btn">Limpiar pantalla</button>
          <button id="reset" class="btn">Restablecer filtros</button>
        </div>
      </aside>

      <!-- LISTA DE ALERTAS -->
      <section class="panel" style="min-height:60vh">
        <div id="alerts" class="alerts"></div>
      </section>
    </main>

    <script>
      (function () {
        const alertsEl = document.getElementById('alerts');

        // Estado
        const ALL = [];
        let renderTimer = null;

        // UI refs
        const qEl = document.getElementById('q');
        const langES = document.getElementById('lang-es');
        const langEN = document.getElementById('lang-en');
        const langOTH = document.getElementById('lang-oth');
        const trustedOnly = document.getElementById('trusted-only');
        const domainsEl = document.getElementById('domains');
        const limitEl = document.getElementById('limit');
        const clearBtn = document.getElementById('clear');
        const resetBtn = document.getElementById('reset');
        const catEls = () => [...document.querySelectorAll('.cat')];

        // ----- Persistencia -----
        const LS_KEY = 'news_alert_filters_v1';

        function saveFilters() {
          const cats = catEls().map(el => [el.value, el.checked]);
          const data = {
            q: qEl.value,
            lang: { es: langES.checked, en: langEN.checked, oth: langOTH.checked },
            trusted: trustedOnly.checked,
            domains: domainsEl.value,
            limit: limitEl.value,
            cats
          };
          try { localStorage.setItem(LS_KEY, JSON.stringify(data)); } catch {}
        }

        function loadFilters() {
          try {
            const raw = localStorage.getItem(LS_KEY);
            if (!raw) return;
            const data = JSON.parse(raw);
            if (typeof data.q === 'string') qEl.value = data.q;
            if (data.lang) {
              if (typeof data.lang.es === 'boolean') langES.checked = data.lang.es;
              if (typeof data.lang.en === 'boolean') langEN.checked = data.lang.en;
              if (typeof data.lang.oth === 'boolean') langOTH.checked = data.lang.oth;
            }
            if (typeof data.trusted === 'boolean') trustedOnly.checked = data.trusted;
            if (typeof data.domains === 'string') domainsEl.value = data.domains;
            if (data.limit) limitEl.value = String(data.limit);
            if (Array.isArray(data.cats)) {
              const map = new Map(data.cats);
              catEls().forEach(el => { if (map.has(el.value)) el.checked = !!map.get(el.value); });
            }
          } catch {}
        }

        function resetFilters() {
          qEl.value = '';
          langES.checked = true; langEN.checked = true; langOTH.checked = true;
          trustedOnly.checked = false;
          domainsEl.value = '';
          limitEl.value = '100';
          catEls().forEach(el => el.checked = true);
          saveFilters();
          scheduleRender();
        }

        loadFilters();

        // Guardar en cada cambio
        [qEl, langES, langEN, langOTH, trustedOnly, domainsEl, limitEl].forEach(el=>{
          el.addEventListener('input', ()=>{ saveFilters(); scheduleRender(); });
          el.addEventListener('change', ()=>{ saveFilters(); scheduleRender(); });
        });
        catEls().forEach(el=>{
          el.addEventListener('change', ()=>{ saveFilters(); scheduleRender(); });
        });

        clearBtn.addEventListener('click', () => { alertsEl.innerHTML = ''; });
        resetBtn.addEventListener('click', resetFilters);

        // ----- WebSocket -----
        const TRUSTED = ["reuters.com","bloomberg.com","wsj.com","ft.com","apnews.com"];
        function wsUrl(){ return (location.protocol==='https:'?'wss://':'ws://') + location.host + '/ws/news'; }
        let ws, backoff=1000;
        connect();

        function connect(){
          ws = new WebSocket(wsUrl());
          ws.addEventListener('open', ()=>{ backoff=1000; console.log('WS open'); });
          ws.addEventListener('message', (ev)=>{
            try {
              const evt = JSON.parse(ev.data);
              evt.domain = (evt.domain || "").toLowerCase();
              evt.language = (evt.language || "").toLowerCase();
              ALL.push(evt);
              scheduleRender();
            } catch(e){ console.warn('parse fail', e); }
          });
          ws.addEventListener('close', ()=>{ setTimeout(connect, Math.min(backoff,30000)); backoff*=2; });
          ws.addEventListener('error', ()=>{ try{ws.close();}catch{} });
        }

        // ----- Filtros -----
        function passLanguage(lang){
          if(!lang) return langOTH.checked;
          if((lang.startsWith('es') || lang==='spanish') && !langES.checked) return false;
          if((lang.startsWith('en') || lang==='english') && !langEN.checked) return false;
          if(!(lang.startsWith('es')||lang==='spanish'||lang.startsWith('en')||lang==='english') && !langOTH.checked) return false;
          return true;
        }

        function passDomain(domain){
          if(trustedOnly.checked && !TRUSTED.some(d=>domain.includes(d))) return false;
          const manual = domainsEl.value.trim();
          if(manual){
            const allow = manual.split(',').map(s=>s.trim().toLowerCase()).filter(Boolean);
            if(allow.length && !allow.some(d=>domain.includes(d))) return false;
          }
          return true;
        }

        function passCategory(cat){
          const ok = catEls().filter(el=>el.checked).map(el=>el.value);
          return ok.includes(cat || 'News');
        }

        function passQuery(evt){
          const q = qEl.value.trim().toLowerCase();
          if(!q) return true;
          const hay = (evt.headline||'') + ' ' + (evt.summary||'') + ' ' + (evt.domain||'');
          return hay.toLowerCase().includes(q);
        }

        function applyFilters(){
          const lim = parseInt(limitEl.value, 10) || 100;
          const out = [];
          for(let i=ALL.length-1; i>=0 && out.length<lim; i--){
            const e = ALL[i];
            if(!passLanguage(e.language)) continue;
            if(!passDomain(e.domain||'')) continue;
            if(!passCategory(e.category)) continue;
            if(!passQuery(e)) continue;
            out.push(e);
          }
          return out;
        }

        // ----- Render -----
        function scheduleRender(){
          if(renderTimer) return;
          renderTimer = requestAnimationFrame(()=>{ renderTimer=null; render(); });
        }

        function prettyDate(ts){
          try{
            if(!ts) return '';
            const d = new Date(ts);
            if(Number.isNaN(d.getTime())) return '';
            return d.toLocaleString();
          }catch{ return ''; }
        }

        function render(){
          const list = applyFilters();
          alertsEl.innerHTML = '';
          for(const evt of list){
            const card = document.createElement('div');
            card.className = 'alert-card';

            const head = document.createElement('div');
            head.className = 'alert-header';

            const h = document.createElement('div');
            h.className = 'alert-headline';
            if(evt.url){
              const a = document.createElement('a');
              a.href = evt.url; a.target="_blank"; a.rel="noopener noreferrer";
              a.textContent = evt.headline || '(sin título)';
              h.appendChild(a);
            }else{
              h.textContent = evt.headline || '(sin título)';
            }

            const cat = document.createElement('div');
            cat.className = 'alert-category';
            cat.textContent = (evt.category || 'NEWS').toUpperCase();

            head.appendChild(h);
            head.appendChild(cat);

            const sum = document.createElement('div');
            sum.className = 'alert-summary';
            const src = evt.domain ? `Fuente: ${evt.domain}` : '';
            sum.textContent = [src, (evt.summary||'')].filter(Boolean).join(' — ');

            const meta = document.createElement('div');
            meta.className = 'alert-meta';
            if(Array.isArray(evt.tickers)){
              for(const t of evt.tickers){
                const sp = document.createElement('span');
                sp.className='ticker'; sp.textContent=String(t).toUpperCase();
                meta.appendChild(sp);
              }
            }
            const time = document.createElement('span');
            time.className = 'muted';
            const pretty = prettyDate(evt.ts || evt.timestamp || '');
            if(pretty) { time.textContent = pretty; meta.appendChild(time); }

            card.appendChild(head);
            if(sum.textContent) card.appendChild(sum);
            card.appendChild(meta);
            alertsEl.appendChild(card);
          }
        }

        // Primer render con filtros recuperados
        scheduleRender();
      })();
    </script>
  </body>
</html>
